<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS/APR Concluídas</title>
    <style>
        /* Estilos CSS idênticos ao ossolicitadas.html, incluindo logo neon */
        :root {
            --cor-laranja-principal: #FF8C00;
            --cor-laranja-secundario: #FFA500;
            --cor-laranja-hover: #e67e00;
            --cor-verde: #2E8B57;
            --cor-verde-hover: #256d44;
            --cor-azul-info: #5bc0de;
            --cor-azul-info-hover: #31b0d5;
            --cor-azul-imprimir: #4682B4;
            /* SteelBlue */
            --cor-azul-imprimir-hover: #3a6a91;
            --cor-cinza-salvar: #777;
            --cor-cinza-salvar-hover: #555;
            --cor-texto: #333333;
            --cor-fundo: #f9f9f9;
            --cor-branco: #FFFFFF;
            --cor-borda: #ddd;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
        }

        .container {
            max-width: 1100px;
            margin: 1rem auto;
            background-color: var(--cor-branco);
            padding: 1.5rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--cor-laranja-principal);
        }

        /* Logo */
        .logo-container {
            position: relative;
            width: 220px;
            height: 130px;
            margin: 0 auto 1.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-imagem {
            display: block;
            max-width: 180px;
            max-height: 90px;
            width: auto;
            height: auto;
            position: relative;
            z-index: 2;
        }

        /* Classe para a imagem */
        .logo-frame {
            position: absolute;
            width: 110px;
            height: 110px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            border: 3px solid var(--cor-laranja-principal);
            z-index: 1;
            border-radius: 5px;
            animation: neon-oscillate 4s linear infinite;
        }

        @keyframes neon-oscillate {

            0%,
            100% {
                border-color: var(--cor-laranja-secundario);
                box-shadow: 0 0 5px var(--cor-laranja-secundario), 0 0 10px var(--cor-laranja-secundario), 0 0 15px var(--cor-laranja-principal), inset 0 0 5px var(--cor-laranja-secundario);
            }

            50% {
                border-color: var(--cor-verde);
                box-shadow: 0 0 5px var(--cor-verde), 0 0 10px var(--cor-verde), 0 0 15px var(--cor-verde-hover), inset 0 0 5px var(--cor-verde);
            }
        }

        h1 {
            color: var(--cor-laranja-principal);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 0;
        }

        /* Botões de Navegação no Topo */
        .botoes-topo {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Botão de Voltar e Botão de Nova OS/APR Atualizado */
        .botao-menu,
        .botao-nova-os-apr {
            border: none;
            padding: 0.8rem 1.4rem;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
            color: var(--cor-branco);
            display: inline-block;
            font-weight: 500;
        }

        .botao-menu {
            background-color: var(--cor-verde);
        }

        .botao-nova-os-apr {
            background-color: var(--cor-laranja-secundario);
        }

        /* Nome da classe atualizado semanticamente */
        .botao-menu:hover {
            background-color: var(--cor-verde-hover);
            transform: translateY(-2px);
        }

        .botao-nova-os-apr:hover {
            background-color: var(--cor-laranja-hover);
            transform: translateY(-2px);
        }

        /* Tabela */
        .tabela-os-apr-container {
            overflow-x: auto;
        }

        /* Nome da classe atualizado */
        .tabela-os-apr {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        /* Nome da classe atualizado */
        .tabela-os-apr th,
        .tabela-os-apr td {
            border: 1px solid var(--cor-borda);
            padding: 0.9rem;
            text-align: left;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .tabela-os-apr th {
            background-color: var(--cor-laranja-secundario);
            color: var(--cor-branco);
            font-weight: bold;
            white-space: nowrap;
        }

        .tabela-os-apr tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .tabela-os-apr tr:hover {
            background-color: #fff3e0;
        }

        /* Botões de Ação na Tabela */
        .tabela-os-apr td .acoes button {
            color: var(--cor-branco);
            border: none;
            padding: 0.5rem 0.9rem;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.4rem;
            transition: background-color 0.3s ease;
            display: inline-block;
            margin-bottom: 0.3rem;
        }

        .tabela-os-apr td .acoes button.ver {
            background-color: var(--cor-laranja-principal);
        }

        .tabela-os-apr td .acoes button.ver:hover {
            background-color: var(--cor-laranja-hover);
        }

        .tabela-os-apr td .acoes button.imprimir {
            background-color: var(--cor-azul-imprimir);
        }

        .tabela-os-apr td .acoes button.imprimir:hover {
            background-color: var(--cor-azul-imprimir-hover);
        }

        .tabela-os-apr td .acoes button.salvar {
            background-color: var(--cor-cinza-salvar);
        }

        /* Botão Download */
        .tabela-os-apr td .acoes button.salvar:hover {
            background-color: var(--cor-cinza-salvar-hover);
        }

        /* Modal */
        #detalhes-os-apr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        /* ID atualizado */
        #detalhes-os-apr-content {
            background-color: var(--cor-branco);
            margin: 5% auto;
            padding: 25px 30px;
            border: 1px solid #888;
            width: 85%;
            max-width: 800px;
            border-radius: 8px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            border-top: 5px solid var(--cor-laranja-principal);
        }

        /* ID atualizado */
        #fechar-modal-os-apr {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        /* ID atualizado */
        #fechar-modal-os-apr:hover,
        #fechar-modal-os-apr:focus {
            color: black;
            text-decoration: none;
        }

        #detalhes-os-apr-texto h2 {
            font-size: 1.6rem;
            color: var(--cor-laranja-principal);
            text-align: center;
            border: none;
            padding: 0;
            margin-bottom: 1.5rem;
        }

        /* ID atualizado */
        #detalhes-os-apr-texto h3 {
            font-size: 1.2rem;
            color: var(--cor-laranja-secundario);
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 0.4rem;
        }

        #detalhes-os-apr-texto p {
            margin-bottom: 0.8rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        #detalhes-os-apr-texto strong {
            color: var(--cor-texto);
            font-weight: 600;
        }

        #detalhes-os-apr-texto ul {
            padding-left: 20px;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        #detalhes-os-apr-texto li {
            margin-bottom: 0.4rem;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.6rem;
            }

            .container {
                padding: 1rem 1.5rem;
            }

            .tabela-os-apr th,
            .tabela-os-apr td {
                font-size: 0.9rem;
                padding: 0.7rem;
            }

            /* Classe da tabela atualizada */
            .tabela-os-apr td .acoes button {
                font-size: 0.8rem;
                padding: 0.4rem 0.7rem;
                display: block;
                width: 100%;
                text-align: center;
                margin-bottom: 0.4rem;
                margin-right: 0;
            }

            .botoes-topo {
                justify-content: center;
            }

            #detalhes-os-apr-content {
                width: 92%;
                margin: 8% auto;
                padding: 20px;
            }

            /* ID atualizado */
            #detalhes-os-apr-texto h2 {
                font-size: 1.4rem;
            }

            /* ID atualizado */
            #detalhes-os-apr-texto h3 {
                font-size: 1.1rem;
            }

            #detalhes-os-apr-texto p,
            #detalhes-os-apr-texto li {
                font-size: 0.9rem;
            }

            .logo-container {
                width: 180px;
                height: 110px;
                margin-bottom: 1.5rem;
            }

            .logo-imagem {
                max-width: 150px;
                max-height: 75px;
            }

            .logo-frame {
                width: 90px;
                height: 90px;
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <h1>OS Concluídas</h1>



        <div class="tabela-os-apr-container">
            <table class="tabela-os-apr" id="tabela-os-apr-concluidas">
                <thead>
                    <tr>
                        <th>Nº OS</th>
                        <th>Tipo</th>
                        <th>Área</th>
                        <th>Local/Equip.</th>
                        <th>Data Término</th>
                        <th>Solicitante</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" style="text-align: center;">Carregando OS Concluídas...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="detalhes-os-apr-modal">
        <div id="detalhes-os-apr-content">
            <span id="fechar-modal-os-apr" onclick="fecharModalOSAPR()">&times;</span>
            <div id="detalhes-os-apr-texto">
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- Firebase Configuração ---
        const firebaseConfig = {
            apiKey: "AIzaSyCkuAOsMsGxqCfrhZPGrXag8R7LeaIR9FQ",
            authDomain: "ordemservico-ef731.firebaseapp.com",
            databaseURL: "https://ordemservico-ef731-default-rtdb.firebaseio.com",
            projectId: "ordemservico-ef731",
            storageBucket: "ordemservico-ef731.firebasestorage.app",
            messagingSenderId: "339669417107",
            appId: "1:339669417107:web:4ec47333f9a02aad5ae166"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        /** Carrega as OS/APR salvas no Firebase e exibe na tabela */
        function carregarOSAPRConcluidas() {
            const tabelaBody = document.querySelector('#tabela-os-apr-concluidas tbody');
            tabelaBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Carregando OS/APR Concluídas...</td></tr>';

            database.ref('ordensServico').once('value')
                .then(snapshot => {
                    const osConcluidas = snapshot.val();
                    tabelaBody.innerHTML = '';

                    if (!osConcluidas) {
                        tabelaBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhuma OS/APR concluída encontrada.</td></tr>';
                        return;
                    }

                    Object.keys(osConcluidas).forEach(key => {
                        const os = osConcluidas[key];
                        const row = tabelaBody.insertRow();
                        const dataTerminoFormatada = formatarDataHora(os['data-termino']);

                        row.innerHTML = `
                            <td>${os['numero-os'] || 'N/A'}</td>
                            <td>${os['tipo-os'] || 'N/A'}</td>
                            <td>${os['area-manutencao'] || 'N/A'}</td>
                            <td>${os['localizacao'] || 'N/A'}</td>
                            <td>${dataTerminoFormatada}</td>
                            <td>${os['solicitante'] || 'N/A'}</td>
                            <td class="acoes">
                                <button class="ver" onclick="verOSAPR('${key}')">Ver</button>
                                <button class="imprimir" onclick="imprimirOSAPR('${key}')">Imprimir</button>
                                <button class="salvar" onclick="salvarOSAPR('${key}')">Download</button>
                            </td>
                        `;
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar OS/APR do Firebase:", error);
                    tabelaBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Erro ao carregar OS/APR.</td></tr>';
                });
        }

        /** Abre o modal com os detalhes da OS/APR */
        function verOSAPR(key) {
            database.ref(`ordensServico/${key}`).once('value')
                .then(snapshot => {
                    const os = snapshot.val();
                    if (!os) return;

                    let detalhesHtml = `<h2>Detalhes da OS/APR: ${os['numero-os']}</h2>`;
                    detalhesHtml += `<p><strong>Tipo:</strong> ${formatarValor(os['tipo-os'])}</p>`;
                    detalhesHtml += `<p><strong>Área:</strong> ${formatarValor(os['area-manutencao'])}</p>`;
                    detalhesHtml += `<p><strong>Local/Equipamento:</strong> ${formatarValor(os['localizacao'])}</p>`;
                    detalhesHtml += `<p><strong>Descrição Serviço/Problema:</strong> ${formatarValor(os['descricao-servico'])}</p>`;
                    detalhesHtml += `<p><strong>Data Emissão:</strong> ${formatarDataHora(os['data-emissao'])}</p>`;
                    detalhesHtml += `<p><strong>Data Término:</strong> ${formatarDataHora(os['data-termino'])}</p>`;
                    detalhesHtml += `<p><strong>Solicitante:</strong> ${formatarValor(os['solicitante'])}</p>`;

                    const executantes = [os['executante1'], os['executante2'], os['executante3']].filter(e => e).join(', ');
                    detalhesHtml += `<p><strong>Executante(s):</strong> ${formatarValor(executantes)}</p>`;

                    if (os['riscos'] && os['riscos'].length > 0) {
                        detalhesHtml += `<p><strong>Riscos Identificados:</strong></p><ul>`;
                        os['riscos'].forEach(r => { detalhesHtml += `<li>${r}</li>`; });
                        detalhesHtml += `</ul>`;
                    }

                    function listarItens(titulo, itensArray) {
                        let html = '';
                        if (itensArray && itensArray.length > 0) {
                            html += `<h3>${titulo}</h3><ul>`;
                            itensArray.forEach(item => {
                                html += `<li>${item.nome} (Qtd: ${item.quantidade})</li>`;
                            });
                            html += `</ul>`;
                        }
                        return html;
                    }
                    detalhesHtml += listarItens('EPIs Utilizados', os['epis_selecionados']);
                    detalhesHtml += listarItens('EPCs Utilizados', os['epcs_selecionados']);
                    detalhesHtml += listarItens('Ferramentas Utilizadas', os['ferramentas_selecionadas']);
                    detalhesHtml += listarItens('Materiais Utilizados', os['materiais_selecionados']);

                    detalhesHtml += `<h3>Observações / Conclusão</h3>`;
                    detalhesHtml += `<p>${formatarValor(os['observacoes'])}</p>`;

                    const modalTexto = document.getElementById('detalhes-os-apr-texto');
                    modalTexto.innerHTML = detalhesHtml;

                    const modal = document.getElementById('detalhes-os-apr-modal');
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error("Erro ao carregar detalhes da OS/APR:", error);
                });
        }

        /** Fecha o modal de detalhes da OS/APR */
        function fecharModalOSAPR() {
            const modal = document.getElementById('detalhes-os-apr-modal');
            modal.style.display = 'none';
        }

        /** Imprime os detalhes da OS/APR */
        function imprimirOSAPR(key) {
            database.ref(`ordensServico/${key}`).once('value')
                .then(snapshot => {
                    const os = snapshot.val();
                    if (!os) return;

                    let detalhesHtml = `<h2>Detalhes da OS/APR: ${os['numero-os']}</h2>`;
                    detalhesHtml += `<p><strong>Tipo:</strong> ${formatarValor(os['tipo-os'])}</p>`;
                    detalhesHtml += `<p><strong>Área:</strong> ${formatarValor(os['area-manutencao'])}</p>`;
                    detalhesHtml += `<p><strong>Local/Equipamento:</strong> ${formatarValor(os['localizacao'])}</p>`;
                    detalhesHtml += `<p><strong>Descrição Serviço/Problema:</strong> ${formatarValor(os['descricao-servico'])}</p>`;
                    detalhesHtml += `<p><strong>Data Emissão:</strong> ${formatarDataHora(os['data-emissao'])}</p>`;
                    detalhesHtml += `<p><strong>Data Término:</strong> ${formatarDataHora(os['data-termino'])}</p>`;
                    detalhesHtml += `<p><strong>Solicitante:</strong> ${formatarValor(os['solicitante'])}</p>`;

                    const executantes = [os['executante1'], os['executante2'], os['executante3']].filter(e => e).join(', ');
                    detalhesHtml += `<p><strong>Executante(s):</strong> ${formatarValor(executantes)}</p>`;

                    detalhesHtml += `<h3>Segurança / APR</h3>`;
                    detalhesHtml += `<p><strong>Concorda com a Apr:</strong> ${formatarValor(os['concorda-apr'])}</p>`;

                    if (os['riscos'] && os['riscos'].length > 0) {
                        detalhesHtml += `<p><strong>Riscos Identificados:</strong></p><ul>`;
                        os['riscos'].forEach(r => { detalhesHtml += `<li>${r}</li>`; });
                        detalhesHtml += `</ul>`;
                    }

                    function listarItens(titulo, itensArray) {
                        let html = '';
                        if (itensArray && itensArray.length > 0) {
                            html += `<h3>${titulo}</h3><ul>`;
                            itensArray.forEach(item => {
                                html += `<li>${item.nome} (Qtd: ${item.quantidade})</li>`;
                            });
                            html += `</ul>`;
                        }
                        return html;
                    }
                    detalhesHtml += listarItens('EPIs Utilizados', os['epis_selecionados']);
                    detalhesHtml += listarItens('EPCs Utilizados', os['epcs_selecionados']);
                    detalhesHtml += listarItens('Ferramentas Utilizadas', os['ferramentas_selecionadas']);
                    detalhesHtml += listarItens('Materiais Utilizados', os['materiais_selecionados']);

                    detalhesHtml += `<h3>Observações / Conclusão</h3>`;
                    detalhesHtml += `<p>${formatarValor(os['observacoes'])}</p>`;

                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>Imprimir OS/APR</title>
                                <style>
                                    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
                                    h2, h3 { color: #FF8C00; }
                                    p, ul { margin: 0 0 10px; }
                                    ul { padding-left: 20px; }
                                    strong { color: #333; }
                                </style>
                            </head>
                            <body>
                                ${detalhesHtml}
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                })
                .catch(error => {
                    console.error("Erro ao carregar detalhes da OS/APR para impressão:", error);
                });
        }

        /** Salva os detalhes da OS/APR como um arquivo JSON */
        function salvarOSAPR(key) {
            database.ref(`ordensServico/${key}`).once('value')
                .then(snapshot => {
                    const os = snapshot.val();
                    if (!os) return;

                    const osData = {
                        numeroOS: os['numero-os'] || 'N/A',
                        tipo: os['tipo-os'] || 'N/A',
                        area: os['area-manutencao'] || 'N/A',
                        localEquipamento: os['localizacao'] || 'N/A',
                        descricaoServico: os['descricao-servico'] || 'N/A',
                        dataEmissao: formatarDataHora(os['data-emissao']),
                        dataTermino: formatarDataHora(os['data-termino']),
                        solicitante: os['solicitante'] || 'N/A',
                        executantes: [os['executante1'], os['executante2'], os['executante3']].filter(e => e).join(', '),
                        concordaapr: os['concorda-apr'] || 'N/A',
                        aprNecessaria: os['apr-necessaria'] || 'N/A',
                        inspecaoPrevia: os['inspecao-previa'] || 'N/A',
                        riscos: os['riscos'] || [],
                        riscosOutrosDesc: os['riscos-outros-desc'] || '',
                        episSelecionados: os['epis_selecionados'] || [],
                        epcsSelecionados: os['epcs_selecionados'] || [],
                        ferramentasSelecionadas: os['ferramentas_selecionadas'] || [],
                        materiaisSelecionados: os['materiais_selecionados'] || [],
                        observacoes: os['observacoes'] || 'N/A'
                    };

                    const jsonContent = JSON.stringify(osData, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `OS_APR_${os['numero-os'] || 'desconhecido'}.json`;
                    a.click();

                    URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error("Erro ao salvar OS/APR como JSON:", error);
                });
        }

        /** Funções auxiliares */
        function formatarValor(valor) { if (!valor || valor === 'null' || valor === 'undefined') return 'N/A'; if (typeof valor === 'string') { if (valor.toLowerCase() === 's' || valor.toLowerCase() === 'sim') return 'Sim'; if (valor.toLowerCase() === 'n' || valor.toLowerCase() === 'nao' || valor.toLowerCase() === 'não') return 'Não'; if (valor.toLowerCase() === 'na') return 'N/A'; } if (Array.isArray(valor)) { return valor.length > 0 ? valor.join(', ') : 'N/A'; } return valor; }
        function formatarDataHora(isoString) { if (!isoString) return 'N/A'; try { return new Date(isoString).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); } catch (e) { return isoString; } }

        // --- Inicialização da Página ---
        document.addEventListener('DOMContentLoaded', () => {
            carregarOSAPRConcluidas();
        });
    </script>
</body>

</html>