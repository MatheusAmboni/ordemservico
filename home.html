<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordens abertas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos base (cores, container, etc.) - similares aos outros arquivos */
        :root {
            --cor-laranja-principal: #FF8C00;
            --cor-laranja-secundario: #FFA500;
            --cor-laranja-hover: #e67e00;
            --cor-verde: #2E8B57;
            --cor-verde-hover: #256d44;
            --cor-azul-info: #5bc0de;
            --cor-azul-info-hover: #31b0d5;
            --cor-azul-imprimir: #4682B4;
            /* SteelBlue */
            --cor-azul-imprimir-hover: #3a6a91;
            --cor-compartilhar: #0275d8;
            /* Azul Bootstrap Primary */
            --cor-compartilhar-hover: #025aa5;
            --cor-fazer: #5cb85c;
            /* Verde Sucesso Bootstrap */
            --cor-fazer-hover: #4cae4c;
            --cor-texto: #333333;
            --cor-fundo: #f9f9f9;
            --cor-branco: #FFFFFF;
            --cor-borda: #ddd;
            /* Cores de Prioridade */
            --cor-prioridade-baixa: #2E8B57;
            /* Verde */
            --cor-prioridade-media: #FFD700;
            /* Amarelo Ouro */
            --cor-prioridade-alta: #DC143C;
            /* Vermelho Crimson */
            --cor-prioridade-urgencia: #000000;
            /* Preto */
            --cor-prioridade-texto: #FFFFFF;
            /* Texto branco para boa leitura */
            --cor-prioridade-media-texto: #333;
            /* Texto escuro para amarelo */
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
        }

        .container {
            max-width: 1100px;
            margin: 1rem auto;
            background-color: var(--cor-branco);
            padding: 1.5rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-top: 5px solid var(--cor-laranja-principal);
        }

        /* Logo */
        .logo-container {
            position: relative;
            width: 220px;
            height: 130px;
            margin: 0 auto 1.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-imagem {
            display: block;
            max-width: 180px;
            max-height: 90px;
            width: auto;
            height: auto;
            position: relative;
            z-index: 2;
        }

        .logo-frame {
            position: absolute;
            width: 110px;
            height: 110px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            border: 3px solid var(--cor-laranja-principal);
            z-index: 1;
            border-radius: 5px;
            animation: neon-oscillate 4s linear infinite;
        }

        @keyframes neon-oscillate {

            0%,
            100% {
                border-color: var(--cor-laranja-secundario);
                box-shadow: 0 0 5px var(--cor-laranja-secundario), 0 0 10px var(--cor-laranja-secundario), 0 0 15px var(--cor-laranja-principal), inset 0 0 5px var(--cor-laranja-secundario);
            }

            50% {
                border-color: var(--cor-verde);
                box-shadow: 0 0 5px var(--cor-verde), 0 0 10px var(--cor-verde), 0 0 15px var(--cor-verde-hover), inset 0 0 5px var(--cor-verde);
            }
        }

        h1 {
            color: var(--cor-laranja-principal);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 0;
        }

        /* Botões de Navegação no Topo */
        .botoes-topo {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .botao-menu,
        .botao-nova-solicitacao {
            border: none;
            padding: 0.8rem 1.4rem;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
            color: var(--cor-branco);
            display: inline-block;
            font-weight: 500;
        }

        .botao-menu {
            background-color: var(--cor-verde);
        }

        .botao-nova-solicitacao {
            background-color: var(--cor-azul-info);
        }

        .botao-menu:hover {
            background-color: var(--cor-verde-hover);
            transform: translateY(-2px);
        }

        .botao-nova-solicitacao:hover {
            background-color: var(--cor-azul-info-hover);
            transform: translateY(-2px);
        }

        /* Tabela de Solicitações */
        .tabela-solicitacoes-container {
            overflow-x: auto;
        }

        .tabela-solicitacoes {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .tabela-solicitacoes th,
        .tabela-solicitacoes td {
            border: 1px solid var(--cor-borda);
            padding: 0.9rem;
            text-align: left;
            font-size: 0.95rem;
            vertical-align: middle;
        }

        .tabela-solicitacoes th {
            background-color: var(--cor-laranja-secundario);
            color: var(--cor-branco);
            font-weight: bold;
            white-space: nowrap;
        }

        .tabela-solicitacoes tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .tabela-solicitacoes tr:hover {
            background-color: #fff3e0;
        }

        /* Estilo Célula Prioridade */
        .tabela-solicitacoes td.prioridade-cell {
            text-align: center;
            font-weight: bold;
            color: var(--cor-prioridade-texto);
        }

        .prioridade-baixa {
            background-color: var(--cor-prioridade-baixa);
        }

        .prioridade-media {
            background-color: var(--cor-prioridade-media);
            color: var(--cor-prioridade-media-texto);
        }

        .prioridade-alta {
            background-color: var(--cor-prioridade-alta);
        }

        .prioridade-urgencia {
            background-color: var(--cor-prioridade-urgencia);
        }

        /* Botões de Ação na Tabela - Melhorados */
        .tabela-solicitacoes td .acoes button {
            color: var(--cor-branco);
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 0.4rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tabela-solicitacoes td .acoes button i {
            font-size: 1rem;
        }

        .tabela-solicitacoes td .acoes button.ver {
            background-color: var(--cor-laranja-principal);
        }

        .tabela-solicitacoes td .acoes button.ver:hover {
            background-color: var(--cor-laranja-hover);
            transform: translateY(-2px);
        }

        .tabela-solicitacoes td .acoes button.fazer {
            background-color: var(--cor-fazer);
        }

        .tabela-solicitacoes td .acoes button.fazer:hover {
            background-color: var(--cor-fazer-hover);
            transform: translateY(-2px);
        }

        .tabela-solicitacoes td .acoes button.imprimir {
            background-color: var(--cor-azul-imprimir);
        }

        .tabela-solicitacoes td .acoes button.imprimir:hover {
            background-color: var(--cor-azul-imprimir-hover);
            transform: translateY(-2px);
        }

        .tabela-solicitacoes td .acoes button.compartilhar {
            background-color: var(--cor-compartilhar);
        }

        .tabela-solicitacoes td .acoes button.compartilhar:hover {
            background-color: var(--cor-compartilhar-hover);
            transform: translateY(-2px);
        }

        .tabela-solicitacoes td .acoes button.remover {
            background-color: #dc3545;
        }

        .tabela-solicitacoes td .acoes button.remover:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* Modal (similar ao osok.html) */
        #detalhes-solicitacao-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        #detalhes-solicitacao-content {
            background-color: var(--cor-branco);
            margin: 5% auto;
            padding: 25px 30px;
            border: 1px solid #888;
            width: 85%;
            max-width: 700px;
            border-radius: 8px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            border-top: 5px solid var(--cor-laranja-principal);
        }

        #fechar-modal-solicitacao {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 25px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        #fechar-modal-solicitacao:hover,
        #fechar-modal-solicitacao:focus {
            color: black;
            text-decoration: none;
        }

        #detalhes-solicitacao-texto h2 {
            font-size: 1.6rem;
            color: var(--cor-laranja-principal);
            text-align: center;
            border: none;
            padding: 0;
            margin-bottom: 1.5rem;
        }

        #detalhes-solicitacao-texto p {
            margin-bottom: 0.8rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        #detalhes-solicitacao-texto strong {
            color: var(--cor-texto);
            font-weight: 600;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.6rem;
            }

            .container {
                padding: 1rem 1.5rem;
            }

            .tabela-solicitacoes th,
            .tabela-solicitacoes td {
                font-size: 0.9rem;
                padding: 0.7rem;
            }

            .tabela-solicitacoes td .acoes button {
                font-size: 0.8rem;
                padding: 0.4rem 0.7rem;
                display: block;
                width: 100%;
                text-align: center;
                margin-bottom: 0.4rem;
                margin-right: 0;
            }

            .botoes-topo {
                justify-content: center;
            }

            #detalhes-solicitacao-content {
                width: 92%;
                margin: 8% auto;
                padding: 20px;
            }

            #detalhes-solicitacao-texto h2 {
                font-size: 1.4rem;
            }

            #detalhes-solicitacao-texto p {
                font-size: 0.9rem;
            }

            .logo-container {
                width: 180px;
                height: 110px;
                margin-bottom: 1.5rem;
            }

            .logo-imagem {
                max-width: 150px;
                max-height: 75px;
            }

            .logo-frame {
                width: 90px;
                height: 90px;
            }
        }
    </style>
</head>

<body>
    <div class="container">

        <h1>Ordens abertas</h1>

        <div class="tabela-solicitacoes-container">
            <table class="tabela-solicitacoes" id="tabela-os-solicitadas">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Prazo</th>
                        <th>Prioridade</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" style="text-align: center;">Carregando Solicitações...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="botoes-topo"
            style="text-align: center; margin-top: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 1rem;">
            <button class="botao-nova-solicitacao" onclick="window.location.href='solicitaros.html'"
                style="width: 60px; height: 60px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                +
            </button>
            <button class="botao-menu" onclick="window.location.href='osok.html'" style="width: auto;">
                Concluídas
            </button>
        </div>
    </div>

    <div id="detalhes-solicitacao-modal">
        <div id="detalhes-solicitacao-content">
            <span id="fechar-modal-solicitacao" onclick="fecharModalSolicitacao()">&times;</span>
            <div id="detalhes-solicitacao-texto">
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const STORAGE_KEY_OS_SOLICITADAS_VIEW = 'osSolicitadasView'; // Define the storage key

        const firebaseConfig = {
            apiKey: "AIzaSyCkuAOsMsGxqCfrhZPGrXag8R7LeaIR9FQ",
            authDomain: "ordemservico-ef731.firebaseapp.com",
            databaseURL: "https://ordemservico-ef731-default-rtdb.firebaseio.com",
            projectId: "ordemservico-ef731",
            storageBucket: "ordemservico-ef731.firebasestorage.app",
            messagingSenderId: "339669417107",
            appId: "1:339669417107:web:4ec47333f9a02aad5ae166"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const modalSolic = document.getElementById('detalhes-solicitacao-modal');
        const modalContentSolic = document.getElementById('detalhes-solicitacao-texto');

        function fecharModalSolicitacao() {
            modalSolic.style.display = "none";
            modalContentSolic.innerHTML = '';
        }
        window.onclick = function (event) {
            if (event.target == modalSolic) { fecharModalSolicitacao(); }
        }

        /** Carrega as Solicitações salvas no Firebase */
        function carregarOSSolicitadas() {
            const tabelaBody = document.querySelector('#tabela-os-solicitadas tbody');
            tabelaBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Carregando Solicitações...</td></tr>';

            database.ref('solicitacoes').once('value')
                .then(snapshot => {
                    const solicitacoes = snapshot.val();
                    tabelaBody.innerHTML = '';

                    if (!solicitacoes) {
                        tabelaBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhuma Solicitação de OS encontrada.</td></tr>';
                        return;
                    }

                    const solicitacoesArray = Object.entries(solicitacoes).map(([key, data]) => ({ key, ...data }));
                    solicitacoesArray.sort((a, b) => b.id - a.id);

                    solicitacoesArray.forEach((solicitacao, index) => {
                        const row = tabelaBody.insertRow();
                        let dataSolicFormatada = formatarDataHora(solicitacao.prazoConclusao);
                        let prioridadeClasse = '';
                        let prioridadeTexto = solicitacao.prioridade || 'N/A';
                        switch (prioridadeTexto.toLowerCase()) {
                            case 'baixa': prioridadeClasse = 'prioridade-baixa'; break;
                            case 'media': prioridadeClasse = 'prioridade-media'; break;
                            case 'alta': prioridadeClasse = 'prioridade-alta'; break;
                            case 'urgencia': prioridadeClasse = 'prioridade-urgencia'; break;
                        }

                        row.innerHTML = `
                            <td>${solicitacao.descricao || 'N/A'}</td>
                            <td>${dataSolicFormatada}</td>
                            <td class="prioridade-cell ${prioridadeClasse}">${prioridadeTexto}</td>
                            <td class="acoes">
                                <button class="fazer" onclick="irParaEmitirOS('${solicitacao.key}')">
                                    <i class="fas fa-check-circle"></i> Fazer
                                </button>
                                <button class="imprimir" onclick="imprimirSolicitacao(${index})">
                                    <i class="fas fa-print"></i> Imprimir
                                </button>
                                <button class="remover" onclick="removerSolicitacao('${solicitacao.key}')">
                                    <i class="fas fa-trash-alt"></i> Remover
                                </button>
                            </td>
                        `;
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar solicitações do Firebase:", error);
                    tabelaBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Erro ao carregar solicitações.</td></tr>';
                });
        }

        /** Redireciona para a página de emissão de OS, passando o ID da solicitação */
        function irParaEmitirOS(idSolicitacao) {
            if (!idSolicitacao) {
                console.error("ID da Solicitação não fornecido para irParaEmitirOS");
                alert("Erro: Não foi possível identificar a solicitação para iniciar a OS.");
                return;
            }
            // Constrói a URL com o ID da solicitação como parâmetro
            const urlDestino = `os.html?solicitacaoId=${encodeURIComponent(idSolicitacao)}`;
            console.log("Redirecionando para:", urlDestino);
            window.location.href = urlDestino;
        }

        /** Formata valor (reutilizado) */
        function formatarValor(valor) { if (!valor || valor === 'null' || valor === 'undefined') return 'N/A'; if (typeof valor === 'string') { if (valor.toLowerCase() === 's' || valor.toLowerCase() === 'sim') return 'Sim'; if (valor.toLowerCase() === 'n' || valor.toLowerCase() === 'nao' || valor.toLowerCase() === 'não') return 'Não'; if (valor.toLowerCase() === 'na') return 'N/A'; } if (Array.isArray(valor)) { return valor.length > 0 ? valor.join(', ') : 'N/A'; } return valor; }
        /** Formata data/hora (reutilizado) */
        function formatarDataHora(isoString) { if (!isoString) return 'N/A'; try { return new Date(isoString).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }); } catch (e) { return isoString; } }

        /** Imprime (salva como PDF) a solicitação selecionada diretamente do Firebase */
        function imprimirSolicitacao(index) {
            database.ref('solicitacoes').once('value')
                .then(snapshot => {
                    const solicitacoes = snapshot.val();
                    if (!solicitacoes) {
                        console.error("Nenhuma solicitação encontrada no Firebase.");
                        return;
                    }

                    const solicitacoesArray = Object.entries(solicitacoes).map(([id, data]) => ({ id, ...data }));
                    solicitacoesArray.sort((a, b) => b.id - a.id);

                    const solic = solicitacoesArray[index];
                    if (!solic) return;

                    const osData = `
                <h1>Detalhes da Solicitação</h1>
                <p><strong>ID da Solicitação:</strong> ${solic.id || 'N/A'}</p>
                <p><strong>Solicitante:</strong> ${solic.solicitante || 'N/A'}</p>
                <p><strong>Data da Solicitação:</strong> ${formatarDataHora(solic.prazoConclusao)}</p>
                <p><strong>Prioridade:</strong> ${solic.prioridade || 'N/A'}</p>
                <p><strong>Status:</strong> ${solic.status || 'N/A'}</p>
                <p><strong>Descrição:</strong> ${solic.descricao || 'N/A'}</p>
                <p><strong>Observações:</strong> ${solic.observacoes || 'N/A'}</p>
                `;

                    const janela = window.open('', '_blank');
                    janela.document.write(`
                <html>
                    <head>
                    <title>Solicitação ${solic.id || 'Desconhecida'}</title>
                    </head>
                    <body>
                    ${osData}
                    </body>
                </html>
                `);
                    janela.document.close();
                    janela.print();
                })
                .catch(error => {
                    console.error("Erro ao carregar solicitação do Firebase:", error);
                });
        }

        /** Remove uma solicitação do Firebase */
        function removerSolicitacao(idSolicitacao) {
            if (!idSolicitacao) {
                console.error("ID da Solicitação não fornecido para removerSolicitacao");
                alert("Erro: Não foi possível identificar a solicitação para remover.");
                return;
            }

            if (confirm("Tem certeza de que deseja remover esta solicitação?")) {
                console.log(`Tentando remover solicitação com ID: ${idSolicitacao}`); // Debugging log
                database.ref(`solicitacoes/${idSolicitacao}`).remove()
                    .then(() => {
                        console.log(`Solicitação com ID ${idSolicitacao} removida.`); // Debugging log
                        carregarOSSolicitadas(); // Recarrega a lista
                    })
                    .catch(error => {
                        console.error("Erro ao remover solicitação do Firebase:", error);
                        alert("Erro ao remover a solicitação. Tente novamente.");
                    });
            }
        }

        // --- Inicialização da Página ---
        document.addEventListener('DOMContentLoaded', () => {
            carregarOSSolicitadas();
        });

    </script>
</body>

</html>